<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- CSS only -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"
    />
    <!-- JS, Popper.js, and jQuery -->
    <script
      src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
      integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
      integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
      integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="styles.css" />
    <script src="./vue-script.js"></script>
    <title>HSDS-Validator</title>
  </head>
  <body>
    <div class="mb-5" id="app">
      <div class="row col-12">
        <!-- <div class="col-6 mt-5 container">
          <h1>Validator Home Page</h1>
          <div class="mt-3">
            <ol>
              <li v-for="(rule,index) in rules" :key="index" class="pl-4">
                {{rule}}
              </li>
              <li class="pl-4">
                Status:
                <ol type="a">
                  <li v-for="(rule,index) in status" :key="index" class="pl-4">
                    {{rule}}
                  </li>
                </ol>
              </li>
              <li class="pl-4">
                Results:
                <ol type="a">
                  <li v-for="(rule,index) in results" :key="index" class="pl-4">
                    {{rule}}
                  </li>
                </ol>
              </li>
            </ol>
          </div>
        </div> -->
        <div class="col-12 bg-gray mt-3">
          <h5 class="pt-3 header">Validator - About - Github</h5>
          <p class="mt-4">{{about}}</p>
          <input
            type="file"
            class="mb-1"
            name="zip_file"
            placeholder="Upload Zip"
            id=""
            @change="handleZipUpload($event)"
          /><br />
          <span class="text-muted">* {{condition}}</span>
          <button class="m-2 p-1 btn btn-success" @click="validateZip()">
            Run Validation Process
          </button>
          <div class="row pl-2 pr-2">
            <table class="border-table col-12 mb-3">
              <thead>
                <tr>
                  <td>Data Table</td>
                  <td>Action</td>
                  <td>Status</td>
                  <td>Result</td>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(file,index) in files" :key="index">
                  <td>{{file.name}}</td>
                  <td>
                    <input
                      @change="handleImageUpload($event, index)"
                      title="Choose CSV"
                      class="inputFile"
                      ref="fileInput"
                      type="file"
                      name="chooseFile"
                      id="fileUpload"
                    />
                  </td>
                  <td>{{file.status}}</td>
                  <td>{{file.result}}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    const vueApp = new Vue({
      el: "#app",
      data() {
        return {
          rules: [
            "Data Table: If Uploading a zip, data table names must match HSDS table names",
            "Action: If user is uploading on a table by table basis, this filename doesn't have to match HSDS.The user's filename will appear in the Action Column after upload.",
          ],
          status: [
            "Ready - data is uploaded",
            "No Data - if no data has been uploaded",
            "Processing -if the validator is currently processing the table",
            "Processed - if the validator processed the table",
          ],
          results: [
            "Valid - matches HSDS spec",
            "InValid - doesn't match HSDS spec",
            "Valid with address - all HSDS fields match but additional fields are also present",
          ],
          about:
            "Upload individual data tables or a zip file to see if your data is formatted consistently with the Human Services Data Standard Specification",
          condition:
            "If uploading zip, data table names must match with HSDS table names",
          files: [
            // { name: "datapackage", status: "No Data", result: "-", filename: 'datapackage.json' },
            {
              name: "accessibility_for_disabilities",
              status: "No Data",
              result: "-",
              filename: 'accessibility_for_disabilities'
            },
            { name: "contact", status: "No Data", result: "-" , filename: 'contact'},
            { name: "eligibilty", status: "No Data", result: "-" , filename: 'eligibilty'},
            { name: "funding", status: "No Data", result: "-" , filename: 'funding'},
            { name: "holiday_schedule", status: "No Data", result: "-" , filename: 'holiday_schedule'},
            { name: "language", status: "No Data", result: "-" , filename: 'language'},
            { name: "location", status: "No Data", result: "-" , filename: 'location'},
            { name: "meta_table_description", status: "No Data", result: "-" , filename: 'meta_table_description'},
            { name: "metadata", status: "No Data", result: "-" , filename: 'metadata'},
            { name: "organization", status: "No Data", result: "-" , filename: 'organization_id'},
            { name: "payment_accepted", status: "No Data", result: "-" , filename: 'payments_accepted'},
            { name: "phone", status: "No Data", result: "-" , filename: 'phone'},
            { name: "physical_addresses", status: "No Data", result: "-" , filename: 'physical_address'},
            { name: "postal_addresses", status: "No Data", result: "-" , filename: 'postal_address'},
            { name: "program", status: "No Data", result: "-" , filename: 'program'},
            { name: "regular_schedules", status: "No Data", result: "-" , filename: 'regular_schedule'},
            { name: "required_documents", status: "No Data", result: "-" , filename: 'required_document'},
            { name: "service_areas", status: "No Data", result: "-" , filename: 'service_area'},
            { name: "service", status: "No Data", result: "-" , filename: 'service'},
            { name: "service_at_location", status: "No Data", result: "-" , filename: 'service_at_location'},
            { name: "service_taxonomy", status: "No Data", result: "-" , filename: 'service_taxonomy'},
            { name: "taxonomy", status: "No Data", result: "-" , filename: 'taxonomy'},
          ],
          selectedFile: null,
          responseZip: ''
        };
      },
      methods: {
        async handleImageUpload(event, index){
          this.files[index].status = 'Ready';
          const files = event.target.files
          const formData = new FormData()
          formData.append('file', files[0])
          formData.append('type',  this.files[index].filename)
          this.files[index].status = 'Processing';
          await fetch('/validate/csv', {
            method: 'POST',
            body: formData,
          })
          .then(response => response.json())
          .then(data => {
            this.files[index].status = 'Processed';
            if(data.valid == true) {
              this.files[index].result = 'Valid';
              
            }else {
              this.files[index].result = 'InValid';
            }
            console.log(data)
          })
          .catch(error => {
            this.files[index].status = 'Processing';
            this.files[index].result = 'Error';
            console.error(error, 'sasas')
          })
        },
        async handleZipUpload(event){
          for(const f of this.files) {
            f.status = "Processing";
          }
          const files = event.target.files
          const formData = new FormData()
          formData.append('file', files[0])
          formData.append('type',  'zip')
          await fetch('/validate/zip', {
            method: 'POST',
            body: formData,
          })
          .then(response => response.json())
          .then(data => {
            console.log(data)
            this.responseZip = data; 
            if(data) {
              for(const f of this.files) {
                if(data[f.filename]) {
                  f.result = data[f.filename].valid ? "Valid" : "Invalid";
                  console.log(f.result);
                } else {
                  f.result = "Invalid";
                }
                f.status = "Processed";
              }
            }
          })
          .catch(error => {
            console.error(error, 'sasas')
          })
        },
        validateZip(){
          // console.log(this.responseZip.accessibility_for_disabilities)
          // return false
          this.files.map((data, index) => {
            var name = data.filename
            // console.log(this.responseZip[name], name)
            data.status = 'Processing'
            data.result = this.responseZip[name].valid
            data.status = 'Processed'
          })
        }
      },
    });
  </script>
</html>
